# Auth0

Запуск проекта идет через `contrib/docker/docker-compose.local.yaml` который устанавливается в конфигурации запуска вместе с файлом переменных окружения

## Команды
Перед запуском проекта введите команду
```shell
chmod +x contrib/docker/wait-for-it.sh
```
Для создания суперпользователя введите команду
```shell
python3 manage.py create-superuser
```
Она создаст администратора с логином user@auth0.com и паролем string  
Для указания нужного адреса электронной почты, телефона и пароля используйте параметры -e, -ph, -pw соответственно

## Порядок аутентификции через OAuth

- Направить пользователя на /oauth/grant-access со следующими параметрами:
  - client_id - идентификатор клиентского приложения, зарегистрированного на данном сервисе
  - redirect_uri - URI, на который пользователь должен будет перейти после получения токенов
  - scope - не используется; для будущего использования
  - state - строка, которую данный сервис передаст клиентскому приложению вместе с токенами для защиты от CSRF-атак
- Пользователь либо возвращается на callback приложения, указанный при его регистрации, с токенами, если он уже аутентифицирован в данном сервисе, либо перенаправляется на страницу /auth/login
- Пользователь аутентифицируется в данном сервисе и перенаправляется на callback приложения с токенами и полученным на /oauth/grant-access state


- Для проверки валидности токена используется точка /oauth/validate-token, возвращающая ответ с кодом 200, если auth_token в заголовке Authorization валиден
- Для получения новой пары токенов используется точка /oauth/refresh

## Добавление защиты интеграционным ключом
```python
from src.api.depends import IntegrationServiceApiKey
from fastapi import Depends
async def endpoint(api_key: str = Depends(IntegrationServiceApiKey())):
    pass
```

# Environment Variables

- **Domain**: A logical group of variables.
- The **Domains table** answers the question: *What will stop working if the variables in this domain are not set?*
- In the **Variables table**:
    - **Type** refers to the Pythonic type from `SettingField type_`.
    - **Default** value refers to the value from `SettingField default`.

## Domains

| Domain                 | Description                                      | Usage                                 |
|------------------------|--------------------------------------------------|---------------------------------------|
| app                    | Application configs                              | General application configuration     |
| db                     | PostgreSQL database                              | Store project models data             |
| smtp                   | Email service                                    | Send confirmation codes               |
| sms                    | SMS service                                      | Send confirmation codes               |
| oauth_*                | OAuth client credentials                         | User login/registration via OAuth     |
| event_driven_kafka     | Event Driven Kafka parameters                    | Send events data                      |
| external_service_kafka | External Service Kafka parameters                | Send events data                      |
| integration_token      | Variables related to Integration token mechanism | Configure integration tokens behavior |
| unisender              | Variables related to sending email via Unisender | Configure messages to Unisender       |

## Variables

| Domain                 | Name                                 | Type  | Default                                                          | Example                                                | Description                                                                                                                                                                                                             |
|------------------------|--------------------------------------|-------|------------------------------------------------------------------|--------------------------------------------------------|-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|
| app                    | APP_SECRET_KEY                       | str   | secret                                                           | nrMEefHd3r57...                                        | Session middleware and password hash salt                                                                                                                                                                               |
| app                    | APP_DEBUG                            | str   | false                                                            | false                                                  | Whether to start application in debug mode                                                                                                                                                                              |
| app                    | APP_RESET_CODE_EXPIRATION_DAYS       | int   | 1                                                                | 1                                                      | Expiration time for reset codes, in days                                                                                                                                                                                |
| app                    | APP_MIN_LENGTH_PASSWORD              | int   | 6                                                                | 6                                                      | Minimum password length                                                                                                                                                                                                 |
| app                    | APP_HOST                             | str   | -                                                                | https://auto0.hiddenteam.ru                            | Application host URL                                                                                                                                                                                                    |
| app                    | APP_SEND_CONFIRMATION_VIA_UNISENDER  | bool  | false                                                            | true                                                   | Defines whether after-registration email must be sent via Unisender or SMTP                                                                                                                                             |
| db                     | DATABASE_URL                         | str   | -                                                                | postgresql+asyncpg://auth0_user:admin@db:5432/auth0_db | Async URL of the database                                                                                                                                                                                               |
| db                     | POSTGRES_DB                          | str   | auth0_db                                                         | auth0_db                                               | Name of the PostgreSQL database                                                                                                                                                                                         |
| db                     | POSTGRES_USER                        | str   | auth0_user                                                       | auth0_user                                             | Username for the PostgreSQL database                                                                                                                                                                                    |
| db                     | POSTGRES_PASSWORD                    | str   | -                                                                | -                                                      | Password for the PostgreSQL database                                                                                                                                                                                    |
| db                     | DB_ENGINE_OPTION_POOL_SIZE           | int   | 5                                                                | 5                                                      | Defines the number of connections that the database connection pool can maintain open simultaneously. This optimizes performance by reusing open connections rather than creating new ones for each request.            |
| db                     | DB_ENGINE_OPTION_MAX_OVERFLOW        | int   | 50                                                               | 50                                                     | Sets the maximum number of additional connections that can be created when all connections in the pool are in use. This is useful for handling peak loads when more resources are temporarily needed.                   |
| db                     | DB_ENGINE_OPTION_POOL_RECYCLE        | int   | 600                                                              | 600                                                    | Specifies the time (in seconds) after which a connection will be automatically closed and reopened. This helps prevent issues with connections that may be closed by the database server after being idle for too long. |
| db                     | DB_ENGINE_OPTION_POOL_PRE_PING       | bool  | false                                                            | false                                                  | Determines whether to check (ping) the connection before using it. If enabled, the system will automatically test each connection before use to prevent errors due to inactive or closed connections.                   |
| smtp                   | SMTP_USERNAME                        | str   | -                                                                | example@mail.ru                                        | SMTP username/email                                                                                                                                                                                                     |
| smtp                   | SMTP_PASSWORD                        | str   | -                                                                | 7huTZK4enrMEefHd3r57                                   | SMTP password                                                                                                                                                                                                           |
| smtp                   | SMTP_FROM                            | str   | -                                                                | example@mail.ru                                        | Corporate noreply email                                                                                                                                                                                                 |
| smtp                   | SMTP_PORT                            | int   | 465                                                              | 465                                                    | SMTP port number                                                                                                                                                                                                        |
| smtp                   | SMTP_SERVER                          | str   | -                                                                | smtp.mail.ru                                           | SMTP server address                                                                                                                                                                                                     |
| smtp                   | SMTP_START_TLS                       | bool  | True                                                             | True                                                   | Enable STARTTLS                                                                                                                                                                                                         |
| smtp                   | SMTP_SSL_TLS                         | bool  | False                                                            | False                                                  | Use SSL/TLS for SMTP                                                                                                                                                                                                    |
| sms                    | SMS_LOGIN                            | str   | -                                                                | -                                                      | Login for SMS service                                                                                                                                                                                                   |
| sms                    | SMS_PASSWORD                         | str   | -                                                                | -                                                      | Password for SMS service                                                                                                                                                                                                |
| sms                    | SMS_SERVICE                          | str   | -                                                                | -                                                      | Name of the SMS service provider                                                                                                                                                                                        |
| sms                    | SMS_INTERVAL_MINUTES                 | int   | 30                                                               | 30                                                     | Interval in minutes for SMS sending restrictions                                                                                                                                                                        |
| sms                    | SMS_SMS_COUNT_IN_INTERVAL            | int   | 3                                                                | 3                                                      | Maximum number of SMS messages allowed within the interval                                                                                                                                                              |
| oauth_google           | GOOGLE_CLIENT_ID                     | str   | -                                                                | -                                                      | Google OAuth provider client ID                                                                                                                                                                                         |
| oauth_google           | GOOGLE_CLIENT_SECRET                 | str   | -                                                                | -                                                      | Google OAuth provider client secret                                                                                                                                                                                     |
| oauth_google           | GOOGLE_AUTHORIZATION_URL             | str   | -                                                                | https://accounts.google.com/o/oauth2/auth              | Google OAuth authorization URL                                                                                                                                                                                          |
| oauth_google           | GOOGLE_TOKEN_URL                     | str   | -                                                                | https://oauth2.googleapis.com/token                    | Google OAuth token URL                                                                                                                                                                                                  |
| oauth_google           | GOOGLE_VALIDATE_URL                  | str   | -                                                                | https://openidconnect.googleapis.com/v1/userinfo       | Google OAuth validation URL                                                                                                                                                                                             |
| oauth_google           | GOOGLE_REDIRECT_URI                  | str   | -                                                                | https://yourapp.com/redirect                           | Google OAuth redirect URI                                                                                                                                                                                               |
| oauth_google           | GOOGLE_SCOPE                         | str   | -                                                                | profile,email                                          | Scopes used when requesting user data from Google                                                                                                                                                                       |
| oauth_github           | GITHUB_CLIENT_ID                     | str   | -                                                                | -                                                      | GitHub OAuth provider client ID                                                                                                                                                                                         |
| oauth_github           | GITHUB_CLIENT_SECRET                 | str   | -                                                                | -                                                      | GitHub OAuth provider client secret                                                                                                                                                                                     |
| oauth_github           | GITHUB_AUTHORIZATION_URL             | str   | -                                                                | https://github.com/login/oauth/authorize               | GitHub OAuth authorization URL                                                                                                                                                                                          |
| oauth_github           | GITHUB_TOKEN_URL                     | str   | -                                                                | https://github.com/login/oauth/access_token            | GitHub OAuth token URL                                                                                                                                                                                                  |
| oauth_github           | GITHUB_VALIDATE_URL                  | str   | -                                                                | https://api.github.com/user                            | GitHub OAuth validation URL                                                                                                                                                                                             |
| oauth_github           | GITHUB_REVOKE_TOKEN_URL              | str   | -                                                                | -                                                      | -                                                                                                                                                                                                                       |
| oauth_github           | GITHUB_REDIRECT_URI                  | str   | -                                                                | https://yourapp.com/redirect                           | GitHub OAuth redirect URI                                                                                                                                                                                               |
| oauth_github           | GITHUB_SCOPE                         | str   | -                                                                | read:user                                              | Scopes used when requesting user data from GitHub                                                                                                                                                                       |
| oauth_facebook         | FACEBOOK_CLIENT_ID                   | str   | -                                                                | -                                                      | Facebook OAuth provider client ID                                                                                                                                                                                       |
| oauth_facebook         | FACEBOOK_CLIENT_SECRET               | str   | -                                                                | -                                                      | Facebook OAuth provider client secret                                                                                                                                                                                   |
| oauth_facebook         | FACEBOOK_AUTHORIZATION_URL           | str   | -                                                                | https://www.facebook.com/v10.0/dialog/oauth            | Facebook OAuth authorization URL                                                                                                                                                                                        |
| oauth_facebook         | FACEBOOK_TOKEN_URL                   | str   | -                                                                | https://graph.facebook.com/v10.0/oauth/access_token    | Facebook OAuth token URL                                                                                                                                                                                                |
| oauth_facebook         | FACEBOOK_VALIDATE_URL                | str   | -                                                                | https://graph.facebook.com/me                          | Facebook OAuth validation URL                                                                                                                                                                                           |
| oauth_facebook         | FACEBOOK_REDIRECT_URI                | str   | -                                                                | https://yourapp.com/redirect                           | Facebook OAuth redirect URI                                                                                                                                                                                             |
| oauth_facebook         | FACEBOOK_SCOPE                       | str   | -                                                                | email,public_profile                                   | Scopes used when requesting user data from Facebook                                                                                                                                                                     |
| oauth_instagram        | INSTAGRAM_CLIENT_ID                  | str   | -                                                                | -                                                      | Instagram OAuth provider client ID                                                                                                                                                                                      |
| oauth_instagram        | INSTAGRAM_CLIENT_SECRET              | str   | -                                                                | -                                                      | Instagram OAuth provider client secret                                                                                                                                                                                  |
| oauth_instagram        | INSTAGRAM_AUTHORIZATION_URL          | str   | -                                                                | https://api.instagram.com/oauth/authorize              | Instagram OAuth authorization URL                                                                                                                                                                                       |
| oauth_instagram        | INSTAGRAM_TOKEN_URL                  | str   | -                                                                | https://api.instagram.com/oauth/access_token           | Instagram OAuth token URL                                                                                                                                                                                               |
| oauth_instagram        | INSTAGRAM_VALIDATE_URL               | str   | -                                                                | https://graph.instagram.com/me                         | Instagram OAuth validation URL                                                                                                                                                                                          |
| oauth_instagram        | INSTAGRAM_REDIRECT_URI               | str   | -                                                                | https://yourapp.com/redirect                           | Instagram OAuth redirect URI                                                                                                                                                                                            |
| oauth_instagram        | INSTAGRAM_SCOPE                      | str   | -                                                                | user_profile,email                                     | Scopes used when requesting user data from Instagram                                                                                                                                                                    |
| event_driven_kafka     | EVENT_DRIVEN_KAFKA_TOPIC             | str   | Events                                                           | topic-name                                             | Kafka topic for event-driven messaging                                                                                                                                                                                  |
| event_driven_kafka     | EVENT_DRIVEN_KAFKA_ADDRESS           | str   | kafka:9092                                                       | kafka:9092                                             | Kafka address for event-driven system                                                                                                                                                                                   |
| event_driven_kafka     | EVENT_DRIVEN_KAFKA_SEND_TIMEOUT      | float | 3.0                                                              | 10                                                     | Timeout for sending messages to event-driven Kafka                                                                                                                                                                      |
| external_service_kafka | EXTERNAL_SERVICE_KAFKA_TOPIC         | str   | Events                                                           | topic-name                                             | Kafka topic to send email and sms via external-service                                                                                                                                                                  |
| external_service_kafka | EXTERNAL_SERVICE_KAFKA_ADDRESS       | str   | kafka:9092                                                       | kafka:9092                                             | Kafka address of external-service                                                                                                                                                                                       |
| external_service_kafka | EXTERNAL_SERVICE_KAFKA_SEND_TIMEOUT  | float | 3.0                                                              | 10                                                     | Timeout for sending messages to external-service Kafka                                                                                                                                                                  |
| integration_token      | INTEGRATION_TOKEN_HEADER_NAME        | str   | X-Integration-Token                                              | X-Integration-Key                                      | The name of the request header that contains integration token                                                                                                                                                          |
| integration_token      | INTEGRATION_TOKEN_EXPIRATION_TIME    | int   | 2592000                                                          | 3600                                                   | The amount of seconds integration token will be considered valid after signing                                                                                                                                          |
| -                      | JWT_SECRET_KEY                       | str   | 09d25e094faa6ca2556c818166b7a9563b93f7099f6f0f4caa6cf63b88e8d3e7 | -                                                      | Secret key used to sign JWT tokens                                                                                                                                                                                      |
| -                      | OAUTH_SECRET_KEY                     | str   | 1164znbm8jjmb3l9aqe0wz8t45ni30h3vev65p02pannvv1xwku9v74g98spw4us | -                                                      | Secret key used for OAuth token operations                                                                                                                                                                              |
| -                      | SQL_SCHEMA_PATH                      | str   | ./schema.sql                                                     | ./schema.sql                                           | Path to the file where the SQL schema will be saved                                                                                                                                                                     |
| unisender              | UNISENDER_REGISTER_CODE_TEMPLATE_ID  | str   | -                                                                | 6319230                                                | ID of Unisender template to be sent to user after registration                                                                                                                                                          |
| unisender              | UNISENDER_PASSWORD_RESET_TEMPLATE_ID | str   | -                                                                | 6319230                                                | ID of Unisender template to be sent to user for password recovery                                                                                                                                                       |
